@model online_sms_site.Models.mainmodel
@{
    ViewBag.Title = "texting";
    Layout = "~/Views/Shared/_messaginglayout.cshtml";
}
@{
    int myid = Convert.ToInt32(Session["user_id"]);

}
@if (Session["error"] != null)
            {
                @Html.Raw(Session["error"])
    Session.Remove("error");
}
<!-- start: Content side -->
<div class="content-sidebar">
    <div class="content-sidebar-title">Text Sms </div>
    <div class="px-3 mb-2">
        <button type="button" data-bs-toggle="modal" data-bs-target="#newmessage" class="btn btn-light w-100 mb-2"> <i class="ri-chat-new-line"></i> New Message</button>
        <button type="button" data-bs-toggle="modal" data-bs-target="#addcontact" class="btn btn-light w-100"><i class="ri-add-circle-fill"></i> Add Contact</button>
    </div>

    <div class="content-messages">
        <ul class="content-messages-list">

            @foreach (var contact in Model.contactlist)
            {
                <input hidden value="@contact.name" id="name_@contact.contact_number" />

                <li>
                    <a data-conversation="#conversation-@contact.Id">
                        @if (contact.status == false)
                        {
                            <span class="content-message-info">
                                
                                <span class="content-message-name" style="font-size:large"><i class="ri-user-line" style="font-size:xx-large"></i> @contact.contact_number</span>
                                <span class="content-message-name">@contact.name</span>

                            </span>
                        }
                        else
                        {
                            
                            <span class="content-message-info">
                                <span class="content-message-name" style="font-size:large"><i class="ri-user-add-line" style="font-size:xx-large"></i> @contact.name</span>
                                <span class="content-message-name">@contact.contact_number</span>
                            </span>

                        }


                        <span>
                            <i class="ri-arrow-right-s-line"></i>
                        </span>

                    </a>
                </li>


            }


        </ul>

    </div>
</div>
<!-- end: Content side -->
<!-- start: Conversation -->
<div class="conversation conversation-default active">
    <i class="ri-chat-3-line"></i>
    <p>Select chat and view conversation!</p>
    
</div>
@foreach (var conversation in Model.contactlist)
{
    <div class="conversation" id="conversation-@conversation.Id">
        @if (conversation.status == false)
        {
            <div class="conversation-top">
                <button type="button" class="conversation-back"><i class="ri-arrow-left-line"></i></button>

                <div class="conversation-user">

                    <div>
                        <div class="conversation-user-name">+92 @conversation.contact_number</div>
                        <div style="color:white">
                            <span>@conversation.name</span>
                        </div>
                    </div>

                </div> <div style="margin-left:auto">
                    <input hidden id="id_@conversation.contact_number" value="@conversation.Id" />
                    <button type="button" data-bs-toggle="modal" data-bs-target="#editcontact" data-user-id="@conversation.contact_number" class="btn btn-outline-light add"><i class="ri-add-circle-fill"></i> Add  Contact</button>
                </div>
            </div>}
        else
        {
            <div class="conversation-top">
                <button type="button" class="conversation-back"><i class="ri-arrow-left-line"></i></button>
                <div class="conversation-user">

                    <img class="conversation-user-image" src="~/assets//images//user-icon.png" alt="">
                    <div>
                        <div class="conversation-user-name">@conversation.name</div>
                        <div class="" style="color:white">
                            <span>+92 @conversation.contact_number</span>
                        </div>
                    </div>


                </div>



            </div>
        }


        <div class="conversation-main">

            <ul class="conversation-wrapper" id="chats_@conversation.contact_number">
                @foreach (var msgs in Model.texts)
                {
                    if (msgs.from == myid && msgs.to == conversation.contact_number)
                    {
                        <li class="conversation-item ">

                            <div class="conversation-item-content">
                                <div class="conversation-item-wrapper">
                                    <div class="conversation-item-box">
                                        <div class="conversation-item-text">
                                            <p>@msgs.text</p>
                                            <div class="conversation-item-time">@msgs.time</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </li>

                    }
                }
            </ul>
        </div>
        @using (Html.BeginForm("index", "texting", FormMethod.Post))
        {
            <div class="conversation-form">

                <div class="conversation-form-group">
                    

                    @Html.HiddenFor(model => model.sendtext.to, new { id = $"to_number-{conversation.contact_number}" })
                    @Html.HiddenFor(model => model.sendtext.name_of_receiver, new { id = $"name_OF_receiver-{conversation.contact_number}" })
                    <input hidden id="nameofreceiver_@conversation.contact_number" value="@conversation.name" />
                    @Html.TextAreaFor(model => model.sendtext.text, new { @class = "conversation-form-input", row = 1, placeholder = "Type here...", Required = "Required" , minlength = "1", maxlength = "120" })

                </div>

                <button type="submit" data-user-id="@conversation.contact_number" class=" conversation-form-button conversation-form-submit"><i class="ri-send-plane-2-line"></i></button>

            </div>
         }
    </div>}
<div class="modal fade" id="newmessage" tabindex="-1" aria-labelledby="newmessageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" >

                @using (Html.BeginForm("index", "texting", FormMethod.Post))
                {
                    <h5 class="modal-title mt-3 ml-3" id="exampleModalLabel"><i class="ri-chat-new-line"></i> Send Text Message </h5>

                    <div class="row" style=" padding: 2rem 2rem;">
                        <div class="mb-6">

                            <label for="number" class="form-label">Phone Number </label>
                            <div class="row">
                                <div class="col-3">
                                    <input class="form-control" value="+92" disabled />
                                </div>
                                <div class="col-9">
                                    @Html.EditorFor(model => model.sendtext.to, new { htmlAttributes = new { @class = "form-control mb-2", id = "number_", Required = "Required", Type = "tel", maxlength = "10", minlength = "10" } })
                                    @Html.DropDownListFor(model => model.sendtext.to, new SelectList(ViewBag.dropdown), "Select number", new { @class = "form-select mb-2", style = "display:none", id = "dropdownlist" })
                                </div>
                            </div>
                            <button style="border:none;background:transparent" type="button" id="addfromcontact" data-title="Add From contact"><i class="ri-add-circle-fill"></i>Add From Contacts</button>
                            <button style="border:none;background:transparent;display:none" type="button" id="notaddfromcontact" data-title="Add From contact"><i class="ri-add-circle-fill"></i>Dont Add From Contacts</button>

                        </div>
                        <div class="mb-6 mt-3">
                            <label for="name" class="form-label" disabled>Name </label>
                            @Html.EditorFor(model => model.sendtext.name_of_receiver, new { htmlAttributes = new { @class = "form-control", id = "name_", Required = "Required" } })

                        </div>
                        <br />
                        <div class="mb-6 mt-3">
                            <label for="message" class="form-label">Message </label>
                            @Html.TextAreaFor(model => model.sendtext.text, new { @class = "form-control", rows = "3", Required = "Required", minlength = "1", maxlength = "120" })

                        </div>
                    </div>
                    <div class="modal-footer mt-3">
                        <button type="submit" class="btn btn-success"><i class="ri-chat-4-line"></i> Send Message</button>


                    </div>
                }


            </div>

           
        </div>
    </div>
</div>
<div class="modal fade" id="addcontact" tabindex="-1" aria-labelledby="addcontactModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style=" padding: 2rem 2rem;">

                @using (Html.BeginForm("addcontact","User", FormMethod.Post , new {id="addcontact_form"}))
                {
                    <h5 class="modal-title mb-3" id="exampleModalLabel"> <i class="ri-add-circle-fill"></i>  Add Contact</h5>

                    <div class="row mb-3">
                        <div class="mb-6">
                            <label for="number" class="form-label">Phone Number </label>

                            <div class="row">
                                <div class="col-3">
                                    <input class="form-control" value="+92" disabled />
                                </div>
                                <div class="col-9">
                                    @Html.EditorFor(model => model.addcontact.contact_number, new { htmlAttributes = new { @class = "form-control mb-2",id="contact_number", Required = "Required" , Type = "tel", maxlength = "11", minlength = "11" } })
                                    @*@Html.ValidationMessageFor(model => model.addcontact.contact_number, "", new { @class = "text-danger" })*@

                                </div>
                            </div>
                        </div>
                        <br />
                        <br />
                        <div class="mb-6">
                            <label for="name" class="form-label">Name </label>
                            @Html.EditorFor(model => model.addcontact.name, new { htmlAttributes = new { @class = "form-control mb-2" ,id="contact_name" , Required = "Required"} })
                            @*@Html.ValidationMessageFor(model => model.addcontact.name, "", new { @class = "text-danger" })*@

                        </div>

                    </div>

                    <div class="modal-footer mt-3 mb-0">
                        <button type="submit " class="btn btn-primary" id="addcontact"> <i class="ri-add-fill"></i>Add Contact</button>
                    </div>
                }

            </div>

        </div>
    </div>
</div>
<div class="modal fade" id="editcontact" tabindex="-1" aria-labelledby="addcontactModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style=" padding: 2rem 2rem;">

                @using (Html.BeginForm("editcontact", "User", FormMethod.Post))
                {
                    <h5 class="modal-title mb-3" id="exampleModalLabel"> <i class="ri-add-circle-fill"></i>  Add Contact</h5>

                    <div class="row mb-3">
                        <div class="mb-6">
                            <label for="number" class="form-label">Phone Number </label>
                            @Html.EditorFor(model => model.addcontact.contact_number, new { htmlAttributes = new { @class = "form-control mb-2", id = "num_", Required = "Required" } })
                          

                        </div>
                        <br />
                        <br />
                        <div class="mb-6">
                            <label for="name" class="form-label">Name </label>
                            @Html.EditorFor(model => model.addcontact.name, new { htmlAttributes = new { @class = "form-control mb-2", id = "addname_", Required = "Required" } })

                            <input name="id" hidden id="Id" />
                            <input name="page" hidden value="texting" />
                        </div>

                    </div>

                    <div class="modal-footer mt-3 mb-0">
                        <button type="submit" class="btn btn-primary"> <i class="ri-add-fill"></i>Add Contact</button>
                    </div>
                }

            </div>

        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        $(".conversation-form-submit").click(function () {
            var number_to = $(this).data("user-id");
            var nameofreceiver = $(`#nameofreceiver_${number_to}`).val()
            $(`#name_OF_receiver-${number_to}`).val(nameofreceiver)
            $(`#to_number-${number_to}`).val(number_to)
            //$.ajax({
            //    type: "POST",
            //    url: "/User/sendtext",
            //    data: {
            //        number_to: to
                   
            //    },
            //    success: function (result) {
            //        $(`#chats_${number_to}`).append(result);
            //        $(".conversation-form-submit").val("");
            //    },
            //    error: function (xhr, status, error) {
            //        console.log(xhr);
            //        console.log(status);
            //        console.log(error);
            //        alert('Error from server:', error);
            //    }
            //});


        });
        $("#addfromcontact").click(function () {
            $("#number_").prop("type", "hidden")
            $("#dropdownlist").css("display", "block")
            $("#notaddfromcontact").css("display", "block")
            $("#addfromcontact").css("display", "none")
        })
        $("#notaddfromcontact").click(function () {
            $("#number_").prop("type", "number")
            $("#dropdownlist").css("display", "none")
            $("#notaddfromcontact").css("display", "none")
            $("#addfromcontact").css("display", "block")
        })
        $("#dropdownlist").change(function () {
            var number = $("#dropdownlist").val()
            var name = $(`#name_${number}`).val()
            $("#name_").val(name) 
            $("#name_").prop("disabled", true) 

        })
        $(".add").click(function () {
            var number_ = $(this).data("user-id");
            var name = $(`#name_${number_}`).val()
            var id = $(`#id_${number_}`).val()
            $("#Id").val(id)
            $("#addname_").val(name)
            $("#num_").val(number_)
        })
       
    })
</script>